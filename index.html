<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YY3 STEAM HKDSE 衝刺計劃</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      // Tailwind CSS Dark Mode Configuration
      tailwind.config = {
        darkMode: 'class',
      }
    </script>
    
    <!-- PWA Manifest (Embedded) & Theme -->
    <link id="manifest-link" rel="manifest">
    <meta name="theme-color" content="#4a90e2" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#1e3a8a" media="(prefers-color-scheme: dark)">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/4a90e2/ffffff?text=YY3">

    <style>
        /* 基本樣式與動畫 */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
        }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex; justify-content: center; align-items: center;
            z-index: 50; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-backdrop.active { opacity: 1; visibility: visible; }
        .modal-content { transform: scale(0.9); transition: transform 0.3s ease; }
        .modal-backdrop.active .modal-content { transform: scale(1); }

        /* 日曆樣式 */
        .calendar-grid { grid-template-columns: repeat(7, minmax(0, 1fr)); }
        .dse-day { position: relative; }
        .dse-day::after {
            content: attr(data-subject); position: absolute;
            bottom: 2px; left: 0; right: 0; font-size: 0.6rem; line-height: 0.7rem;
            color: #c0392b; font-weight: bold; text-align: center;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        html.dark .dse-day::after { color: #f87171; }
        
        /* 載入中動畫 */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex; justify-content: center; align-items: center;
            z-index: 100; opacity: 0; visibility: hidden; transition: opacity 0.3s;
        }
        #loader.active { opacity: 1; visibility: visible; }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <!-- 載入中動畫 -->
    <div id="loader"><div class="spinner"></div></div>

    <!-- 主容器 -->
    <div id="app" class="max-w-4xl mx-auto min-h-screen bg-white dark:bg-gray-800 shadow-lg">

        <!-- 登入頁面 -->
        <div id="login-page" class="page active">
            <div class="min-h-screen flex flex-col items-center justify-center bg-blue-50 dark:bg-gray-900 p-4">
                <div class="w-full max-w-sm text-center">
                    <h1 class="text-3xl font-bold text-blue-800 dark:text-blue-300">YY3 STEAM</h1>
                    <h2 class="text-4xl font-extrabold text-blue-600 dark:text-blue-400 mb-6">HKDSE 衝刺計劃</h2>
                    
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-md mb-6">
                        <p class="text-lg text-gray-600 dark:text-gray-400 mb-1">距離 DSE 尚餘</p>
                        <div id="countdown-timer" class="text-4xl font-bold text-red-500">-- 天 --:--:--</div>
                        <p id="motivational-quote" class="text-gray-700 dark:text-gray-300 italic px-4 py-2 bg-yellow-100 dark:bg-yellow-900/50 border-l-4 border-yellow-400 rounded-r-lg mt-4"></p>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-md">
                        <input id="login-id" type="text" placeholder="使用者 ID" class="w-full px-4 py-3 mb-4 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input id="login-password" type="password" placeholder="密碼" class="w-full px-4 py-3 mb-6 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="login-button" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 dark:hover:bg-blue-500 transition-colors">登入</button>
                        <p id="login-error" class="text-red-500 dark:text-red-400 mt-4 h-5"></p>
                    </div>
                </div>
                <div class="absolute bottom-4 right-4 text-xs text-gray-400 dark:text-gray-500">
                    <p>Lonely Chan & AI 共同開發</p>
                </div>
            </div>
        </div>

        <!-- 學生/管理員主頁面 -->
        <div id="main-page" class="page">
            <header class="bg-blue-600 dark:bg-blue-900 text-white p-4 flex justify-between items-center sticky top-0 z-10 shadow-md">
                <div id="header-left">
                    <h1 id="main-title" class="text-xl font-bold">溫習日曆</h1>
                    <div id="admin-controls" class="hidden mt-2">
                        <select id="student-selector" class="bg-blue-700 dark:bg-blue-800 text-white border border-blue-400 dark:border-blue-600 rounded-md py-1 px-2 text-sm">
                            <option value="">選擇學生</option>
                        </select>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="theme-toggle-button" class="p-2 rounded-full hover:bg-blue-700 dark:hover:bg-blue-800 transition-colors"></button>
                    <button id="stats-button" class="bg-white text-blue-600 dark:bg-gray-700 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg shadow hover:bg-gray-200 dark:hover:bg-gray-600 transition">統計</button>
                    <button id="logout-button" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-red-600 transition">登出</button>
                </div>
            </header>

            <main class="p-4">
                <div class="flex justify-between items-center mb-4">
                    <button id="prev-month" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600">&lt;</button>
                    <h2 id="current-month-year" class="text-2xl font-bold"></h2>
                    <button id="next-month" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600">&gt;</button>
                </div>

                <div class="grid calendar-grid gap-1 text-center font-semibold text-gray-600 dark:text-gray-400 mb-2">
                    <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
                </div>
                <div id="calendar-body" class="grid calendar-grid gap-1"></div>
            </main>
        </div>
    </div>

    <!-- 溫習紀錄 Modal -->
    <div id="record-modal" class="modal-backdrop">
        <div class="modal-content bg-white dark:bg-gray-800 w-full max-w-lg m-4 p-6 rounded-2xl shadow-xl max-h-[90vh] overflow-y-auto">
            <h3 id="modal-date" class="text-2xl font-bold mb-4 text-center"></h3>
            <div id="record-list"></div>
            <div id="modal-actions" class="mt-6 flex flex-col sm:flex-row justify-between items-center space-y-2 sm:space-y-0 sm:space-x-2">
                 <button id="add-record-item" class="w-full sm:w-auto flex-grow bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 transition">新增項目</button>
                 <div class="w-full sm:w-auto flex flex-grow space-x-2">
                    <button id="save-records" class="w-1/2 flex-grow bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition">儲存</button>
                    <button id="close-record-modal" class="w-1/2 flex-grow bg-gray-400 dark:bg-gray-600 text-white py-2 px-4 rounded-lg hover:bg-gray-500 dark:hover:bg-gray-500 transition">關閉</button>
                 </div>
            </div>
            <p id="record-modal-info" class="text-center text-gray-500 mt-4 hidden">管理員唯讀模式</p>
        </div>
    </div>
    
    <!-- 統計 Modal -->
    <div id="stats-modal" class="modal-backdrop">
        <div class="modal-content bg-white dark:bg-gray-800 w-full max-w-lg m-4 p-6 rounded-2xl shadow-xl">
            <h3 class="text-2xl font-bold mb-2 text-center">當月溫習統計</h3>
            <p id="stats-user-id" class="text-center text-gray-500 dark:text-gray-400 mb-4"></p>
            <p class="text-center text-lg mb-4">總時數: <span id="total-hours" class="font-bold text-blue-600 dark:text-blue-400">0</span> 小時</p>
            <div class="w-full max-w-xs mx-auto"><canvas id="subject-chart"></canvas></div>
            <div class="mt-6 text-center">
                <button id="close-stats-modal" class="bg-gray-400 dark:bg-gray-600 text-white py-2 px-6 rounded-lg hover:bg-gray-500 dark:hover:bg-gray-500 transition">關閉</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 設定 ---
        // !!! 重要 !!! 請將此處替換為你部署後的 Google Apps Script Web App 網址
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbx5WgyWltWhRIaxAM23k6XUJ2obGMwIy14XxUkrFBXzl2IpPuGt3dKx4AzrY7WyewOkyQ/exec';

        // --- 全局變數和常數 ---
        const DSE_TARGET_DATE = new Date('2026-04-09T00:00:00');
        const QUOTES = ["每一次的努力，都是未來最好的鋪墊。", "堅持下去，不是因為你會成功，而是因為你不想後悔。", "成功的路上並不擁擠，因為堅持的人不多。", "今天你所受的苦，會照亮你未來的路。", "別讓現在的懶，變成未來的難。", "天賦決定上限，努力決定下限。", "你必須很努力，才能看起來毫不費力。"];
        const SUBJECTS = ["中文", "英文", "數學", "物理", "化學", "生物", "M2", "中史", "西史", "地理", "經濟", "旅款", "企會財", "ICT", "VA"];
        const DSE_EXAM_DATES = {'2026-04-08':'視覺藝術', '2026-04-09':'中文', '2026-04-10':'英文(一)(二)', '2026-04-11':'英文(三)', '2026-04-13':'數學', '2026-04-14':'公社', '2026-04-16':'化學', '2026-04-20':'生物', '2026-04-22':'物理', '2026-04-23':'地理', '2026-04-24':'ICT', '2026-04-25':'歷史', '2026-04-27':'企會財', '2026-04-29':'中史', '2026-04-30':'M2', '2026-05-02':'旅款', '2026-05-04':'經濟'};

        let state = {
            currentPage: 'login-page',
            currentUser: null,
            currentDate: new Date(),
            studentData: {},
            viewingStudentId: null,
            chartInstance: null,
        };
        
        // --- DOM 元素 ---
        const loader = document.getElementById('loader');
        const pages = document.querySelectorAll('.page');
        const countdownTimerEl = document.getElementById('countdown-timer');
        const quoteEl = document.getElementById('motivational-quote');
        const loginIdEl = document.getElementById('login-id');
        const loginPasswordEl = document.getElementById('login-password');
        const loginButton = document.getElementById('login-button');
        const loginErrorEl = document.getElementById('login-error');
        const currentMonthYearEl = document.getElementById('current-month-year');
        const calendarBodyEl = document.getElementById('calendar-body');
        const recordModal = document.getElementById('record-modal');
        const statsModal = document.getElementById('stats-modal');
        const themeToggleButton = document.getElementById('theme-toggle-button');

        // --- 後端服務 (真實 API) ---
        const callGas = async (action, payload = {}) => {
            if (GAS_URL === '在此貼上你的 Google Apps Script Web App 網址') {
                alert('錯誤：尚未設定 Google Apps Script Web App 網址！');
                throw new Error('GAS_URL not configured.');
            }
            loader.classList.add('active');
            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action, payload }),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // GAS Web App needs text/plain
                });
                const result = await response.json();
                if (!result.success) throw new Error(result.message);
                return result.data;
            } catch (error) {
                console.error('GAS Call Error:', error);
                alert(`與伺服器通訊失敗: ${error.message}`);
                throw error;
            } finally {
                loader.classList.remove('active');
            }
        };

        const gasService = {
            login: (id, password) => callGas('login', { id, password }),
            getStudentData: (studentId) => callGas('getStudentData', { studentId }),
            saveStudentData: (studentId, dateKey, data) => callGas('saveStudentData', { studentId, dateKey, data }),
            getAllStudents: () => callGas('getAllStudents'),
        };

        // --- 核心函式 ---
        const showPage = (pageId) => {
            pages.forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            state.currentPage = pageId;
        };

        const updateCountdown = () => {
            const diff = DSE_TARGET_DATE - new Date();
            if (diff <= 0) { countdownTimerEl.textContent = "考試順利！"; return; }
            const days = Math.floor(diff / 86400000);
            const hours = Math.floor((diff % 86400000) / 3600000);
            const minutes = Math.floor((diff % 3600000) / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);
            countdownTimerEl.textContent = `${days} 天 ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        };
        
        const renderCalendar = () => {
            calendarBodyEl.innerHTML = '';
            const year = state.currentDate.getFullYear();
            const month = state.currentDate.getMonth();
            currentMonthYearEl.textContent = `${year}年 ${month + 1}月`;
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDay; i++) calendarBodyEl.innerHTML += `<div class="p-2 border rounded-lg bg-gray-50 dark:bg-gray-700/50 dark:border-gray-700"></div>`;
            for (let day = 1; day <= daysInMonth; day++) {
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const today = new Date();
                const isToday = year === today.getFullYear() && month === today.getMonth() && day === today.getDate();
                const hasRecord = state.studentData[dateKey];
                const isDseDay = DSE_EXAM_DATES[dateKey];
                let dayClasses = 'p-2 border dark:border-gray-700 rounded-lg cursor-pointer transition-colors relative';
                if(isToday) dayClasses += ' bg-blue-500 text-white font-bold';
                else if (hasRecord) dayClasses += ' bg-green-100 dark:bg-green-900/50 hover:bg-green-200 dark:hover:bg-green-900';
                else dayClasses += ' bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700';
                if (isDseDay) dayClasses += ' dse-day border-red-400 dark:border-red-600 border-2';
                const dayEl = document.createElement('div');
                dayEl.className = dayClasses;
                dayEl.dataset.date = dateKey;
                if(isDseDay) dayEl.dataset.subject = isDseDay;
                dayEl.innerHTML = `<span class="text-sm sm:text-base">${day}</span>${hasRecord ? '<span class="absolute top-1 right-1 text-xs">✅</span>' : ''}`;
                dayEl.addEventListener('click', () => handleDateClick(dateKey));
                calendarBodyEl.appendChild(dayEl);
            }
        };
        
        const handleDateClick = (dateKey) => {
            const data = state.studentData[dateKey] ? JSON.parse(state.studentData[dateKey]) : [];
            const isReadOnly = state.currentUser.role === 'admin';
            if (!isReadOnly || (isReadOnly && data.length > 0)) openRecordModal(dateKey, data, isReadOnly);
        };
        
        const openRecordModal = (dateKey, records, isReadOnly) => {
            document.getElementById('modal-date').textContent = dateKey;
            const recordList = document.getElementById('record-list');
            recordList.innerHTML = '';
            recordList.dataset.date = dateKey;
            if (records.length === 0 && !isReadOnly) addRecordItem(recordList);
            else records.forEach(r => addRecordItem(recordList, r, isReadOnly));
            document.getElementById('modal-actions').classList.toggle('hidden', isReadOnly);
            document.getElementById('record-modal-info').classList.toggle('hidden', !isReadOnly);
            recordModal.classList.add('active');
        };

        const addRecordItem = (container, item = {subject: SUBJECTS[0], hours: '', content: ''}, isReadOnly = false) => {
            const itemEl = document.createElement('div');
            itemEl.className = 'record-item grid grid-cols-1 sm:grid-cols-12 gap-2 mb-3 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg border dark:border-gray-600';
            const subjectOptions = SUBJECTS.map(s => `<option value="${s}" ${item.subject === s ? 'selected' : ''}>${s}</option>`).join('');
            itemEl.innerHTML = `
                <div class="sm:col-span-3"><select class="subject w-full p-2 border rounded-md dark:bg-gray-600 dark:border-gray-500" ${isReadOnly ? 'disabled' : ''}>${subjectOptions}</select></div>
                <div class="sm:col-span-2"><input type="number" step="0.01" class="hours w-full p-2 border rounded-md dark:bg-gray-600 dark:border-gray-500" placeholder="時數" value="${item.hours}" ${isReadOnly ? 'disabled' : ''}></div>
                <div class="sm:col-span-6"><input type="text" class="content w-full p-2 border rounded-md dark:bg-gray-600 dark:border-gray-500" placeholder="溫習內容" value="${item.content}" ${isReadOnly ? 'disabled' : ''}></div>
                <div class="sm:col-span-1 flex items-center justify-end">${!isReadOnly ? '<button class="delete-item-btn text-red-500 hover:text-red-700 font-bold text-xl">×</button>' : ''}</div>
            `;
            if (!isReadOnly) itemEl.querySelector('.delete-item-btn').addEventListener('click', () => itemEl.remove());
            container.appendChild(itemEl);
        };

        const openStatsModal = () => {
            const year = state.currentDate.getFullYear(), month = state.currentDate.getMonth() + 1;
            const monthKey = `${year}-${String(month).padStart(2, '0')}`;
            let totalHours = 0;
            const subjectHours = {};
            Object.keys(state.studentData).forEach(dateKey => {
                if (dateKey.startsWith(monthKey)) {
                    JSON.parse(state.studentData[dateKey]).forEach(r => {
                        const hours = parseFloat(r.hours) || 0;
                        totalHours += hours;
                        subjectHours[r.subject] = (subjectHours[r.subject] || 0) + hours;
                    });
                }
            });
            document.getElementById('total-hours').textContent = totalHours.toFixed(2);
            document.getElementById('stats-user-id').textContent = state.currentUser.role === 'admin' ? `學生: ${state.viewingStudentId}` : '';
            const chartCanvas = document.getElementById('subject-chart');
            if (state.chartInstance) state.chartInstance.destroy();
            const isDark = document.documentElement.classList.contains('dark');
            Chart.defaults.color = isDark ? '#ddd' : '#666';
            state.chartInstance = new Chart(chartCanvas, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(subjectHours),
                    datasets: [{ data: Object.values(subjectHours), backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#8BC34A', '#F44336', '#E91E63', '#9C27B0', '#673AB7', '#3F51B5', '#03A9F4', '#009688', '#CDDC39', '#FFC107'] }]
                },
                options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { position: 'bottom' } } }
            });
            statsModal.classList.add('active');
        };

        // --- 登入/登出/管理員邏輯 ---
        async function login() {
            const id = loginIdEl.value.trim(), password = loginPasswordEl.value.trim();
            if (!id || !password) { loginErrorEl.textContent = '請輸入 ID 和密碼'; return; }
            loginErrorEl.textContent = '';
            try {
                const result = await gasService.login(id, password);
                state.currentUser = { id: result.id, role: result.role };
                if (result.role === 'student') {
                    state.viewingStudentId = result.id;
                    document.getElementById('admin-controls').classList.add('hidden');
                    document.getElementById('main-title').textContent = '溫習日曆';
                    await loadStudentData(result.id);
                } else if (result.role === 'admin') {
                    document.getElementById('admin-controls').classList.remove('hidden');
                    document.getElementById('main-title').textContent = '管理員面板';
                    await setupAdminPage();
                }
                showPage('main-page');
            } catch (error) {
                loginErrorEl.textContent = error.message;
            }
        }

        async function loadStudentData(studentId) {
            state.studentData = await gasService.getStudentData(studentId);
            renderCalendar();
        }

        async function setupAdminPage() {
            const students = await gasService.getAllStudents();
            const selector = document.getElementById('student-selector');
            selector.innerHTML = '<option value="">選擇學生</option>';
            students.forEach(id => {
                const option = document.createElement('option');
                option.value = id; option.textContent = id;
                selector.appendChild(option);
            });
            state.studentData = {};
            renderCalendar();
        }

        function logout() {
            state = { ...state, currentUser: null, studentData: {}, viewingStudentId: null };
            loginIdEl.value = ''; loginPasswordEl.value = ''; loginErrorEl.textContent = '';
            showPage('login-page');
        }

        // --- 主題切換 ---
        const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>`;
        const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>`;

        const applyTheme = (theme) => {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                themeToggleButton.innerHTML = sunIcon;
            } else {
                document.documentElement.classList.remove('dark');
                themeToggleButton.innerHTML = moonIcon;
            }
        };

        const toggleTheme = () => {
            const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        };
        themeToggleButton.addEventListener('click', toggleTheme);

        // --- 事件監聽器 ---
        loginButton.addEventListener('click', login);
        loginPasswordEl.addEventListener('keyup', (e) => { if(e.key === 'Enter') login(); });
        document.getElementById('logout-button').addEventListener('click', logout);
        document.getElementById('stats-button').addEventListener('click', openStatsModal);
        document.getElementById('close-stats-modal').addEventListener('click', () => statsModal.classList.remove('active'));
        document.getElementById('prev-month').addEventListener('click', () => { state.currentDate.setMonth(state.currentDate.getMonth() - 1); renderCalendar(); });
        document.getElementById('next-month').addEventListener('click', () => { state.currentDate.setMonth(state.currentDate.getMonth() + 1); renderCalendar(); });
        document.getElementById('close-record-modal').addEventListener('click', () => recordModal.classList.remove('active'));
        document.getElementById('add-record-item').addEventListener('click', () => addRecordItem(document.getElementById('record-list')));
        document.getElementById('save-records').addEventListener('click', async () => {
            const recordList = document.getElementById('record-list');
            const dateKey = recordList.dataset.date;
            const dataToSave = Array.from(recordList.querySelectorAll('.record-item')).map(item => ({
                subject: item.querySelector('.subject').value,
                hours: parseFloat(item.querySelector('.hours').value) || 0,
                content: item.querySelector('.content').value.trim(),
            })).filter(item => item.content || item.hours > 0);
            await gasService.saveStudentData(state.viewingStudentId, dateKey, JSON.stringify(dataToSave));
            await loadStudentData(state.viewingStudentId);
            recordModal.classList.remove('active');
        });
        document.getElementById('student-selector').addEventListener('change', async (e) => {
            const studentId = e.target.value;
            if (studentId) {
                state.viewingStudentId = studentId;
                await loadStudentData(studentId);
            } else {
                state.viewingStudentId = null;
                state.studentData = {};
                renderCalendar();
            }
        });

        // --- 初始化 ---
        const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        applyTheme(savedTheme);
        const manifest = {"name":"YY3 STEAM HKDSE 衝刺計劃","short_name":"DSE衝刺","description":"一個為 HKDSE 考生設計的溫習進度追蹤工具","start_url":".","display":"standalone","background_color":"#f7fafc","theme_color":"#4299e1","orientation":"portrait-primary","icons":[{"src":"https://placehold.co/192x192/4a90e2/ffffff?text=YY3","type":"image/png","sizes":"192x192"},{"src":"https://placehold.co/512x512/4a90e2/ffffff?text=YY3","type":"image/png","sizes":"512x512"}]};
        const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        document.getElementById('manifest-link').href = URL.createObjectURL(manifestBlob);

        quoteEl.textContent = QUOTES[Math.floor(Math.random() * QUOTES.length)];
        setInterval(updateCountdown, 1000);
        updateCountdown();
    });
    </script>
</body>
</html>

