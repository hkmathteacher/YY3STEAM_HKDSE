<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <!-- 修正 1: 禁止用戶縮放畫面 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <title>YY3 STEAM HKDSE 衝刺計劃</title>
    
    <!-- Google Fonts: Inter & Noto Sans TC -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      // Tailwind CSS Dark Mode Configuration
      tailwind.config = {
        darkMode: 'class',
      }
    </script>
    
    <!-- PWA Manifest (Embedded) & Theme -->
    <link id="manifest-link" rel="manifest">
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#1f2937" media="(prefers-color-scheme: dark)">
    <!-- 修正 3: 更新 Apple Touch Icon -->
    <link id="apple-touch-icon" rel="apple-touch-icon">

    <style>
        /* 基本樣式與動畫 */
        body { 
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            -webkit-tap-highlight-color: transparent; /* 移除行動裝置點擊高亮 */
        }
        .page { 
            display: none; /* 所有頁面預設隱藏 */
        }
        .page.active { 
            animation: fadeIn 0.5s ease-in-out; 
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex; justify-content: center; align-items: center;
            z-index: 50; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-backdrop.active { opacity: 1; visibility: visible; }
        .modal-content { transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-backdrop.active .modal-content { transform: scale(1); }

        /* 日曆樣式 */
        .calendar-grid { 
            grid-template-columns: repeat(7, minmax(0, 1fr));
        }
        .calendar-day-cell {
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* 修正：頂部對齊 */
            padding-top: 4px; /* 修正：增加頂部內距 */
            align-items: center;
            position: relative;
            aspect-ratio: 1 / 1;
        }
        .record-indicator {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #27ae60;
        }
        html.dark .record-indicator { background-color: #58d68d; }
        .dse-subject-text {
            font-size: 0.65rem;
            line-height: 1;
            margin-top: 2px;
            color: #c0392b;
            font-weight: bold;
            text-align: center;
        }
        html.dark .dse-subject-text { color: #f87171; }
        
        /* 載入中動畫 */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex; justify-content: center; align-items: center;
            z-index: 100; opacity: 0; visibility: hidden; transition: opacity 0.3s;
        }
        #loader.active { opacity: 1; visibility: visible; }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <!-- 載入中動畫 -->
    <div id="loader"><div class="spinner"></div></div>

    <!-- 主容器 -->
    <div id="app" class="max-w-4xl mx-auto min-h-screen bg-white dark:bg-gray-800">

        <!-- 登入頁面 -->
        <div id="login-page" class="page">
            <div class="min-h-screen flex flex-col bg-white dark:bg-gray-900 p-6">
                <header class="flex justify-between items-center mb-16">
                    <div>
                        <h1 class="text-xl font-bold text-blue-600 dark:text-blue-400">YY3 STEAM</h1>
                        <h2 class="text-lg text-gray-800 dark:text-gray-200">HKDSE 衝刺計劃</h2>
                    </div>
                    <button id="login-theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"></button>
                </header>
                
                <main class="flex-grow flex flex-col justify-center text-center">
                    <div class="mb-10">
                        <p class="text-lg text-gray-500 dark:text-gray-400">距離 HKDSE 尚餘</p>
                        <div id="countdown-timer" class="text-7xl font-bold text-blue-600 dark:text-blue-400 my-2">--</div>
                        <p class="text-lg text-gray-500 dark:text-gray-400">日</p>
                    </div>

                    <div class="w-full max-w-sm mx-auto">
                        <div class="mb-4">
                            <label class="block text-left text-gray-600 dark:text-gray-400 mb-1 ml-1">帳號 ID</label>
                            <input id="login-id" type="text" class="w-full px-4 py-3 border-none rounded-lg bg-gray-100 dark:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="mb-6">
                             <label class="block text-left text-gray-600 dark:text-gray-400 mb-1 ml-1">密碼</label>
                            <input id="login-password" type="password" class="w-full px-4 py-3 border-none rounded-lg bg-gray-100 dark:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <button id="login-button" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 dark:hover:bg-blue-500 transition-colors">登入</button>
                        <p id="motivational-quote" class="text-gray-500 dark:text-gray-400 italic mt-6"></p>
                        <p id="login-error" class="text-red-500 dark:text-red-400 mt-4 h-5"></p>
                    </div>
                </main>

                <footer class="text-center text-xs text-gray-400 dark:text-gray-500 py-4">
                    <p>Lonely Chan & AI 共同開發</p>
                </footer>
            </div>
        </div>

        <!-- 學生/管理員主頁面 (自適應高度佈局) -->
        <div id="main-page" class="page flex-col h-screen">
            <header class="px-4 py-3 flex justify-between items-center sticky top-0 z-10 flex-shrink-0 border-b border-gray-200 dark:border-gray-700">
                <div id="header-left" class="flex items-center gap-2 overflow-hidden">
                    <h1 id="main-title" class="text-xl font-bold truncate">溫習日曆</h1>
                    <div id="admin-controls" class="hidden">
                        <select id="student-selector" class="bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 border border-gray-300 dark:border-gray-600 rounded-md py-1 px-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="">選擇學生</option>
                        </select>
                    </div>
                </div>
                <div class="flex items-center space-x-1">
                    <button id="stats-button" title="統計" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>
                    </button>
                    <button id="main-theme-toggle" title="切換主題" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"></button>
                    <button id="logout-button" class="font-semibold text-red-500 hover:text-red-600 dark:text-red-400 dark:hover:text-red-500 transition px-3 py-2 text-sm">登出</button>
                </div>
            </header>

            <main class="p-4 flex flex-col flex-grow">
                <div class="flex justify-between items-center mb-4 flex-shrink-0">
                    <button id="prev-month" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">&lt;</button>
                    <h2 id="current-month-year" class="text-2xl font-bold"></h2>
                    <button id="next-month" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">&gt;</button>
                </div>

                <div class="grid calendar-grid gap-x-1 text-center font-semibold text-gray-600 dark:text-gray-400 mb-2 flex-shrink-0">
                    <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
                </div>
                <div id="calendar-body" class="grid calendar-grid gap-x-1 gap-y-0 flex-grow"></div>
            </main>
        </div>
    </div>

    <!-- 溫習紀錄 Modal (v8.2 設計) -->
    <div id="record-modal" class="modal-backdrop">
        <div class="modal-content bg-gray-100 dark:bg-gray-900 w-full max-w-lg m-4 p-6 rounded-2xl shadow-xl max-h-[90vh] flex flex-col">
            <header class="flex justify-between items-center mb-4 flex-shrink-0">
                 <h3 id="modal-title" class="text-xl font-bold"></h3>
                 <button id="close-record-modal" class="text-gray-500 dark:text-gray-400 hover:text-black dark:hover:text-white text-2xl font-bold">&times;</button>
            </header>
            <div id="record-list" class="flex-grow overflow-y-auto pr-2"></div>
            <div id="add-item-wrapper" class="mt-3 flex-shrink-0">
                <button id="add-record-item" class="w-full border-2 border-dashed border-gray-400 dark:border-gray-600 text-gray-500 dark:text-gray-400 rounded-lg py-3 hover:bg-gray-200 dark:hover:bg-gray-800 transition font-semibold text-sm">
                    + 新增項目
                </button>
            </div>
            <div id="modal-actions" class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-2 flex-shrink-0">
                 <button id="clear-records-btn" class="bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition font-semibold text-sm">清空本日</button>
                 <button id="save-records" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition font-semibold text-sm">儲存</button>
            </div>
             <div id="admin-modal-footer" class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700 text-center hidden flex-shrink-0">
                <p id="record-modal-info" class="text-center text-gray-500">管理員唯讀模式</p>
            </div>
        </div>
    </div>
    
    <!-- 統計 Modal -->
    <div id="stats-modal" class="modal-backdrop">
        <div class="modal-content bg-white dark:bg-gray-800 w-full max-w-lg m-4 p-6 rounded-2xl shadow-xl max-h-[90vh] flex flex-col">
            <h3 id="stats-modal-title" class="text-2xl font-bold mb-2 text-center"></h3>
            <p id="stats-user-id" class="text-center text-gray-500 dark:text-gray-400 mb-4"></p>
            <p class="text-center text-lg mb-4">總時數: <span id="total-hours" class="font-bold text-blue-600 dark:text-blue-400">0</span> 小時</p>
            <div class="w-full max-w-xs mx-auto flex-shrink-0"><canvas id="subject-chart"></canvas></div>
            <div id="stats-details-list" class="mt-6 text-left flex-grow overflow-y-auto pr-2"></div>
            <div class="mt-6 text-center flex-shrink-0">
                <button id="close-stats-modal" class="bg-gray-500 dark:bg-gray-600 text-white py-2 px-6 rounded-lg hover:bg-gray-600 dark:hover:bg-gray-500 transition font-semibold">關閉</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 設定 ---
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbzMAAGK8egg_0xodccJFgJRxtl97nqJDoHZvbx9wo_iT4sgXTgHtwzYc1AEVICtBSbD4Q/exec';

        // --- 全局變數和常數 ---
        const DSE_TARGET_DATE = new Date('2026-04-09T00:00:00');
        const QUOTES = ["每一次的努力，都是未來最好的鋪墊。", "堅持下去，不是因為你會成功，而是因為你不想後悔。", "成功的路上並不擁擠，因為堅持的人不多。", "今天你所受的苦，會照亮你未來的路。", "別讓現在的懶，變成未來的難。", "天賦決定上限，努力決定下限。", "你必須很努力，才能看起來毫不費力。"];
        const SUBJECTS = ["中文", "英文", "數學", "物理", "化學", "生物", "M2", "中史", "西史", "地理", "經濟", "旅款", "企會財", "ICT", "VA"];
        const DSE_EXAM_DATES = {'2026-04-08':'視覺藝術', '2026-04-09':'中文', '2026-04-10':'英文(一)(二)', '2026-04-11':'英文(三)', '2026-04-13':'數學', '2026-04-14':'公社', '2026-04-16':'化學', '2026-04-20':'生物', '2026-04-22':'物理', '2026-04-23':'地理', '2026-04-24':'ICT', '2026-04-25':'歷史', '2026-04-27':'企會財', '2026-04-29':'中史', '2026-04-30':'M2', '2026-05-02':'旅款', '2026-05-04':'經濟'};
        const CHART_COLORS_LIGHT = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#8BC34A', '#F44336', '#E91E63', '#9C27B0', '#673AB7', '#3F51B5', '#03A9F4', '#009688', '#CDDC39'];
        const CHART_COLORS_DARK = ['#d65773', '#5daeec', '#e3b84e', '#66c9c9', '#ad8cfa', '#e38f38', '#a0ce68', '#dc5a50', '#d13c70', '#b04abf', '#815ec7', '#6072c0', '#2cb4dc', '#2ca598', '#d3e05a'];

        let state = {
            currentUser: null, currentDate: new Date(), studentData: {},
            viewingStudentId: null, chartInstance: null,
        };
        
        // --- DOM 元素 ---
        const loader = document.getElementById('loader');
        const pages = document.querySelectorAll('.page');
        const countdownTimerEl = document.getElementById('countdown-timer');
        const quoteEl = document.getElementById('motivational-quote');
        const loginIdEl = document.getElementById('login-id');
        const loginPasswordEl = document.getElementById('login-password');
        const loginButton = document.getElementById('login-button');
        const loginErrorEl = document.getElementById('login-error');
        const currentMonthYearEl = document.getElementById('current-month-year');
        const calendarBodyEl = document.getElementById('calendar-body');
        const recordModal = document.getElementById('record-modal');
        const statsModal = document.getElementById('stats-modal');
        const themeToggleButtons = [document.getElementById('login-theme-toggle'), document.getElementById('main-theme-toggle')];

        // --- 後端服務 ---
        const callGas = async (action, payload = {}) => {
            if (GAS_URL.includes('在此貼上')) {
                alert('錯誤：尚未設定 Google Apps Script Web App 網址！請在 index.html 檔案中找到 GAS_URL 變數，並貼上你的後端網址。');
                throw new Error('GAS_URL not configured.');
            }
            loader.classList.add('active');
            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST', body: JSON.stringify({ action, payload }),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                });
                const result = await response.json();
                if (!result.success) throw new Error(result.message);
                return result.data;
            } catch (error) {
                console.error('GAS Call Error:', error);
                alert(`與伺服器通訊失敗: ${error.message}`);
                throw error;
            } finally {
                loader.classList.remove('active');
            }
        };

        const gasService = {
            login: (id, password) => callGas('login', { id, password }),
            getStudentData: (studentId) => callGas('getStudentData', { studentId }),
            saveStudentData: (studentId, dateKey, data) => callGas('saveStudentData', { studentId, dateKey, data }),
            getAllStudents: () => callGas('getAllStudents'),
        };

        // --- 核心函式 ---
        const showPage = (pageId) => {
            pages.forEach(p => {
                p.classList.remove('active');
                p.style.display = 'none'; 
            });
            const activePage = document.getElementById(pageId);
            activePage.classList.add('active');
            if (pageId === 'main-page') {
                activePage.style.display = 'flex'; 
            } else {
                activePage.style.display = 'block';
            }
        };

        const updateCountdown = () => {
            const diff = DSE_TARGET_DATE - new Date();
            if (diff <= 0) { countdownTimerEl.textContent = "✓"; return; }
            const days = Math.floor(diff / 86400000);
            countdownTimerEl.textContent = days;
        };
        
        const renderCalendar = () => {
            calendarBodyEl.innerHTML = '';
            const year = state.currentDate.getFullYear();
            const month = state.currentDate.getMonth();
            currentMonthYearEl.textContent = `${year}年 ${month + 1}月`;
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDay; i++) calendarBodyEl.innerHTML += `<div></div>`;
            for (let day = 1; day <= daysInMonth; day++) {
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const today = new Date();
                const isToday = year === today.getFullYear() && month === today.getMonth() && day === today.getDate();
                const hasRecord = state.studentData[dateKey] && JSON.parse(state.studentData[dateKey]).length > 0;
                const isDseDay = DSE_EXAM_DATES[dateKey];

                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day-cell cursor-pointer rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50';
                dayEl.dataset.date = dateKey;
                
                let dayNumberClass = isToday ? "bg-blue-600 text-white font-bold" : "";
                let content = `<span class="w-8 h-8 flex items-center justify-center rounded-full transition-colors ${dayNumberClass}">${day}</span>`;
                
                if(isDseDay) content += `<span class="dse-subject-text">${isDseDay}</span>`;
                if(hasRecord) content += `<div class="record-indicator" title="有溫習紀錄"></div>`;
                
                dayEl.innerHTML = content;
                dayEl.addEventListener('click', () => handleDateClick(dateKey));
                calendarBodyEl.appendChild(dayEl);
            }
        };
        
        const handleDateClick = (dateKey) => {
            const data = state.studentData[dateKey] ? JSON.parse(state.studentData[dateKey]) : [];
            const isReadOnly = state.currentUser.role === 'admin';
            if (!isReadOnly || (isReadOnly && data.length > 0)) openRecordModal(dateKey, data, isReadOnly);
        };
        
        const openRecordModal = (dateKey, records, isReadOnly) => {
            const viewingId = isReadOnly ? state.viewingStudentId : state.currentUser.id;
            document.getElementById('modal-title').textContent = `${viewingId} 於 ${dateKey} 的紀錄`;
            const recordList = document.getElementById('record-list');
            recordList.innerHTML = '';
            recordList.dataset.date = dateKey;

            if (records.length === 0 && !isReadOnly) {
                addRecordItem(recordList);
            } else {
                records.forEach(r => addRecordItem(recordList, r, isReadOnly));
            }
            
            document.getElementById('add-item-wrapper').classList.toggle('hidden', isReadOnly);
            document.getElementById('modal-actions').classList.toggle('hidden', isReadOnly);
            document.getElementById('admin-modal-footer').classList.toggle('hidden', !isReadOnly);
            
            recordModal.classList.add('active');
        };

        const addRecordItem = (container, item = {subject: SUBJECTS[0], hours: '', content: ''}, isReadOnly = false) => {
            const itemEl = document.createElement('div');
            const subjectOptions = SUBJECTS.map(s => `<option value="${s}" ${item.subject === s ? 'selected' : ''}>${s}</option>`).join('');

            if (isReadOnly) {
                itemEl.className = 'record-item bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm mb-3';
                itemEl.innerHTML = `
                    <div class="flex justify-between items-start">
                        <h4 class="text-base font-bold text-blue-600 dark:text-blue-400">${item.subject}</h4>
                        <span class="font-semibold text-sm">${item.hours} 小時</span>
                    </div>
                    <p class="mt-1 text-gray-600 dark:text-gray-400 text-sm">${item.content || '<i>無內容</i>'}</p>
                `;
            } else {
                itemEl.className = 'record-item bg-white dark:bg-gray-800 p-3 rounded-xl shadow-sm mb-3 relative';
                itemEl.innerHTML = `
                    <button class="delete-item-btn absolute top-2 right-2 text-gray-400 hover:text-red-500 text-xl transition-colors">&times;</button>
                    <div class="flex items-center gap-2 mb-2">
                        <select class="subject h-10 flex-1 bg-gray-200 dark:bg-gray-700 border-none rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500">${subjectOptions}</select>
                        <input type="number" step="0.01" class="hours h-10 w-24 bg-gray-200 dark:bg-gray-700 border-none rounded-lg p-2 text-sm text-center focus:ring-2 focus:ring-blue-500" placeholder="時數" value="${item.hours}">
                    </div>
                    <div>
                        <textarea class="content w-full bg-gray-200 dark:bg-gray-700 border-none rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500" rows="2" placeholder="溫習內容...">${item.content || ''}</textarea>
                    </div>
                `;
                 itemEl.querySelector('.delete-item-btn').addEventListener('click', () => itemEl.remove());
            }
            container.appendChild(itemEl);
        };

        const openStatsModal = () => {
            const year = state.currentDate.getFullYear(), month = state.currentDate.getMonth() + 1;
            document.getElementById('stats-modal-title').textContent = `${year}年 ${month}月 溫習統計`;

            const monthKey = `${year}-${String(month).padStart(2, '0')}`;
            let totalHours = 0;
            const subjectHours = {};
            Object.keys(state.studentData).forEach(dateKey => {
                if (dateKey.startsWith(monthKey) && state.studentData[dateKey]) {
                    try {
                        JSON.parse(state.studentData[dateKey]).forEach(r => {
                            const hours = parseFloat(r.hours) || 0;
                            totalHours += hours;
                            subjectHours[r.subject] = (subjectHours[r.subject] || 0) + hours;
                        });
                    } catch (e) { console.error("無法解析統計數據:", state.studentData[dateKey]); }
                }
            });

            document.getElementById('total-hours').textContent = totalHours.toFixed(2);
            document.getElementById('stats-user-id').textContent = state.currentUser.role === 'admin' ? `學生: ${state.viewingStudentId}` : '';
            
            const statsDetailsList = document.getElementById('stats-details-list');
            statsDetailsList.innerHTML = '';
            if (totalHours > 0) {
                const sortedSubjects = Object.entries(subjectHours).sort(([, a], [, b]) => b - a);
                sortedSubjects.forEach(([subject, hours]) => {
                    const percentage = ((hours / totalHours) * 100).toFixed(1);
                    const detailEl = document.createElement('div');
                    detailEl.className = 'flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700 text-sm';
                    detailEl.innerHTML = `<span>${subject}</span><span class="font-semibold text-right">${hours.toFixed(2)} 小時<br><span class="text-xs text-gray-500 dark:text-gray-400">(${percentage}%)</span></span>`;
                    statsDetailsList.appendChild(detailEl);
                });
            } else {
                statsDetailsList.innerHTML = '<p class="text-center text-gray-500">本月暫無紀錄</p>';
            }

            if (state.chartInstance) state.chartInstance.destroy();
            const isDarkMode = document.documentElement.classList.contains('dark');
            Chart.defaults.color = isDarkMode ? '#ddd' : '#666';
            state.chartInstance = new Chart(document.getElementById('subject-chart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(subjectHours),
                    datasets: [{ 
                        data: Object.values(subjectHours), 
                        backgroundColor: isDarkMode ? CHART_COLORS_DARK : CHART_COLORS_LIGHT,
                        borderColor: isDarkMode ? 'rgb(31 41 55)' : 'rgb(255, 255, 255)', 
                        borderWidth: 2
                    }]
                },
                options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: Object.keys(subjectHours).length > 0, position: 'bottom' } } }
            });
            statsModal.classList.add('active');
        };

        // --- 登入/登出/管理員邏輯 ---
        async function login() {
            const id = loginIdEl.value.trim(), password = loginPasswordEl.value.trim();
            if (!id || !password) { loginErrorEl.textContent = '請輸入 ID 和密碼'; return; }
            loginErrorEl.textContent = '';
            try {
                const result = await gasService.login(id, password);
                state.currentUser = { id: result.id, role: result.role };
                if (result.role === 'student') {
                    state.viewingStudentId = result.id;
                    document.getElementById('admin-controls').classList.add('hidden');
                    document.getElementById('main-title').textContent = `${result.id} 的溫習日曆`;
                    await loadStudentData(result.id);
                } else if (result.role === 'admin') {
                    document.getElementById('admin-controls').classList.remove('hidden');
                    document.getElementById('main-title').textContent = '管理員面板';
                    await setupAdminPage();
                }
                showPage('main-page');
            } catch (error) {
                loginErrorEl.textContent = error.message;
            }
        }

        async function loadStudentData(studentId) { 
            state.studentData = await gasService.getStudentData(studentId); 
            renderCalendar(); 
        }
        async function setupAdminPage() {
            const students = await gasService.getAllStudents();
            const selector = document.getElementById('student-selector');
            selector.innerHTML = '<option value="">選擇學生</option>';
            students.forEach(id => selector.add(new Option(id, id)));
            state.studentData = {}; 
            renderCalendar();
        }

        function logout() {
            state = { ...state, currentUser: null, studentData: {}, viewingStudentId: null };
            loginIdEl.value = ''; 
            loginPasswordEl.value = ''; 
            loginErrorEl.textContent = '';
            showPage('login-page');
        }

        // --- 主題切換 ---
        const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>`;
        const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>`;
        const applyTheme = (theme) => {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                themeToggleButtons.forEach(btn => btn.innerHTML = sunIcon);
            } else {
                document.documentElement.classList.remove('dark');
                themeToggleButtons.forEach(btn => btn.innerHTML = moonIcon);
            }
        };
        const toggleTheme = () => {
            const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        };
        themeToggleButtons.forEach(btn => btn.addEventListener('click', toggleTheme));

        // --- 事件監聽器 ---
        loginButton.addEventListener('click', login);
        loginPasswordEl.addEventListener('keyup', (e) => { if(e.key === 'Enter') login(); });
        document.getElementById('logout-button').addEventListener('click', logout);
        document.getElementById('stats-button').addEventListener('click', openStatsModal);
        document.getElementById('close-stats-modal').addEventListener('click', () => statsModal.classList.remove('active'));
        document.getElementById('prev-month').addEventListener('click', () => { state.currentDate.setMonth(state.currentDate.getMonth() - 1); renderCalendar(); });
        document.getElementById('next-month').addEventListener('click', () => { state.currentDate.setMonth(state.currentDate.getMonth() + 1); renderCalendar(); });
        document.getElementById('close-record-modal').addEventListener('click', () => recordModal.classList.remove('active'));
        document.getElementById('add-record-item').addEventListener('click', () => addRecordItem(document.getElementById('record-list')));
        
        document.getElementById('clear-records-btn').addEventListener('click', () => {
            const recordList = document.getElementById('record-list');
            recordList.innerHTML = '';
            addRecordItem(recordList); // Add one blank item back
        });

        document.getElementById('save-records').addEventListener('click', async () => {
            const recordList = document.getElementById('record-list');
            const dataToSave = Array.from(recordList.querySelectorAll('.record-item')).map(item => ({
                subject: item.querySelector('.subject').value,
                hours: parseFloat(item.querySelector('.hours').value) || 0,
                content: item.querySelector('.content').value.trim(),
            // 修正 1: 只有在時數大於0時，該項目才有效
            })).filter(item => item.hours > 0);
            
            await gasService.saveStudentData(state.viewingStudentId, recordList.dataset.date, JSON.stringify(dataToSave));
            await loadStudentData(state.viewingStudentId);
            recordModal.classList.remove('active');
        });

        document.getElementById('student-selector').addEventListener('change', async (e) => {
            const studentId = e.target.value;
            state.viewingStudentId = studentId;
            if (studentId) {
                document.getElementById('main-title').textContent = `${studentId} 的溫習日曆`;
                await loadStudentData(studentId);
            } else {
                document.getElementById('main-title').textContent = '管理員面板';
                state.studentData = {}; 
                renderCalendar();
            }
        });

        // --- 初始化 ---
        const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        applyTheme(savedTheme);

        // 修正 3: 將圖片轉換為 Base64 並更新 Manifest
        const customIconBase64 = "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAH3AfQDASIAAhEBAxEB/8QAGwABAQACAwEAAAAAAAAAAAAAAAEGBwQFAwL/xABIEAABAwIFAgMGAwYEBAUFAAABAgMRAAQFEiExBhNBUWEHInEjgZEUMlKhscFSYnLR4fAIQ4KS8TQlM2Nzshd0g5TC0tT/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/8QAFBEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEQMRAD8A9U0pSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSg-MM-2gUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSgUpSg-";

        const manifest = {
            "name": "YY3 STEAM HKDSE 衝刺計劃",
            // 修正 2: 更新 PWA 短名稱
            "short_name": "STEAM衝刺",
            "description": "一個為 HKDSE 考生設計的溫習進度追蹤工具",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#ffffff",
            "theme_color": "#ffffff",
            "orientation": "portrait-primary",
            "icons":[
                {
                    "src": customIconBase64,
                    "type": "image/jpeg",
                    "sizes":"192x192"
                },
                {
                    "src": customIconBase64,
                    "type": "image/jpeg",
                    "sizes":"512x512"
                }
            ]
        };
        document.getElementById('manifest-link').href = URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type: 'application/json'}));
        document.getElementById('apple-touch-icon').href = customIconBase64;

        quoteEl.textContent = `“${QUOTES[Math.floor(Math.random() * QUOTES.length)]}”`;
        setInterval(updateCountdown, 3600000); 
        updateCountdown();
        showPage('login-page');
    });
    </script>
</body>
</html>


