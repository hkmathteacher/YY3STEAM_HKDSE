<!DOCTYPE html>
<html lang="zh-Hant" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>YY3 STEAM HKDSE 衝刺計劃</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PWA Manifest and Icons -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="DSE Tracker">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/1f2937/ffffff?text=DSE">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        .modal-content { animation: slideUp 0.3s ease-out forwards; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .toast-show { animation: fadeInOut 3s ease-in-out forwards; }
        @keyframes fadeInOut { 0%, 100% { opacity: 0; transform: translateY(20px); } 10%, 90% { opacity: 1; transform: translateY(0); } }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: {} }
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 flex items-center justify-center min-h-screen overflow-hidden">

    <div id="app-container" class="w-full h-full max-w-md mx-auto bg-white dark:bg-gray-800 shadow-lg flex flex-col relative overflow-hidden" style="min-height: 100vh;">

        <!-- Login Page -->
        <div id="login-page" class="flex flex-col h-full justify-center items-center p-8 text-center">
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-indigo-600 dark:text-indigo-400">YY3 STEAM</h1>
                <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-300">HKDSE 衝刺計劃</h2>
            </div>
            <div id="dse-countdown" class="mb-6 text-lg">
                <p class="font-semibold text-gray-600 dark:text-gray-400">距離 HKDSE 尚餘</p>
                <p id="countdown-timer" class="text-4xl font-bold text-indigo-500"></p>
            </div>
            <div id="quote-container" class="mb-6 h-20 flex items-center justify-center p-2 border-t border-b border-gray-200 dark:border-gray-700">
                <p id="daily-quote" class="text-sm italic text-gray-500 dark:text-gray-400"></p>
            </div>
            <input id="user-id" type="text" placeholder="使用者ID" class="w-full mb-4 p-3 rounded-lg bg-gray-100 dark:bg-gray-700 border-2 border-transparent focus:border-indigo-500 focus:ring-0 outline-none transition">
            <input id="user-pw" type="password" placeholder="密碼" class="w-full mb-6 p-3 rounded-lg bg-gray-100 dark:bg-gray-700 border-2 border-transparent focus:border-indigo-500 focus:ring-0 outline-none transition">
            <button id="login-btn" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-bold hover:bg-indigo-700 transition duration-300 shadow-lg">登入</button>
            <p class="absolute bottom-4 right-4 text-xs text-gray-400 dark:text-gray-500">Lonely Chan & AI 共同開發</p>
        </div>

        <!-- Main Page -->
        <div id="main-page" class="hidden flex-col h-full">
            <header class="p-4 bg-white dark:bg-gray-800 shadow-md flex justify-between items-center border-b border-gray-200 dark:border-gray-700">
                <div id="month-navigation">
                    <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">&lt;</button>
                    <span id="current-month-year" class="font-bold text-lg mx-4"></span>
                    <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">&gt;</button>
                </div>
                <div>
                    <button id="stats-btn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">📊</button>
                    <button id="logout-btn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">登出</button>
                </div>
            </header>
            <div id="calendar-header" class="calendar-grid p-2 text-center text-xs text-gray-500 dark:text-gray-400 font-bold border-b border-gray-200 dark:border-gray-700">
                <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
            </div>
            <div id="calendar-body" class="calendar-grid flex-grow p-2 gap-1"></div>
            <footer class="text-center p-2 text-xs text-gray-400 dark:text-gray-500">
                <p id="current-user-id" class="font-mono"></p>
                <p class="absolute bottom-4 right-4 text-xs text-gray-400 dark:text-gray-500">Lonely Chan & AI 共同開發</p>
            </footer>
        </div>

        <!-- Admin Page -->
        <div id="admin-page" class="hidden flex-col h-full">
            <header class="p-4 bg-white dark:bg-gray-800 shadow-md flex justify-between items-center border-b border-gray-200 dark:border-gray-700">
                <select id="student-selector" class="bg-gray-100 dark:bg-gray-700 p-2 rounded-lg"></select>
                <div>
                     <button id="admin-stats-btn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">📊</button>
                    <button id="admin-logout-btn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">登出</button>
                </div>
            </header>
            <div class="p-4">
                <div id="admin-month-navigation">
                    <button id="admin-prev-month-btn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">&lt;</button>
                    <span id="admin-current-month-year" class="font-bold text-lg mx-4"></span>
                    <button id="admin-next-month-btn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">&gt;</button>
                </div>
            </div>
            <div id="admin-calendar-header" class="calendar-grid p-2 text-center text-xs text-gray-500 dark:text-gray-400 font-bold border-b border-gray-200 dark:border-gray-700">
                 <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
            </div>
            <div id="admin-calendar-body" class="calendar-grid flex-grow p-2 gap-1"></div>
             <footer class="p-2 text-center text-xs text-gray-400 dark:text-gray-500">
                <p class="absolute bottom-4 right-4 text-xs text-gray-400 dark:text-gray-500">Lonely Chan & AI 共同開發</p>
            </footer>
        </div>

        <!-- Modals -->
        <div id="edit-modal" class="hidden absolute inset-0 bg-black bg-opacity-50 flex items-end justify-center">
            <div class="modal-content bg-white dark:bg-gray-800 w-full max-w-md p-4 rounded-t-2xl shadow-lg flex-col">
                <h3 id="modal-date" class="font-bold text-lg mb-4 text-center"></h3>
                <div id="entries-container" class="max-h-60 overflow-y-auto pr-2 mb-4"></div>
                <button id="add-entry-btn" class="w-full mb-4 p-2 bg-gray-200 dark:bg-gray-700 text-sm rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition">+ 新增溫習項目</button>
                <div class="flex gap-4">
                    <button id="modal-close-btn" class="w-full bg-gray-500 text-white p-3 rounded-lg font-bold hover:bg-gray-600 transition">關閉</button>
                    <button id="modal-save-btn" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-bold hover:bg-indigo-700 transition">儲存</button>
                </div>
            </div>
        </div>
        
        <div id="stats-modal" class="hidden absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 w-full max-w-md p-6 rounded-2xl shadow-lg">
                <h3 id="stats-title" class="font-bold text-lg mb-4 text-center">溫習時數統計</h3>
                <p class="text-center text-3xl font-bold mb-2 text-indigo-500"><span id="total-hours">0.00</span> 小時</p>
                <p id="stats-month" class="text-center text-sm text-gray-500 dark:text-gray-400 mb-6"></p>
                <div id="subject-stats-container" class="space-y-2 max-h-60 overflow-y-auto"></div>
                <button id="stats-close-btn" class="mt-6 w-full bg-gray-500 text-white p-3 rounded-lg font-bold hover:bg-gray-600 transition">關閉</button>
            </div>
        </div>

        <div id="admin-view-modal" class="hidden absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 w-full max-w-md p-6 rounded-2xl shadow-lg">
                <h3 id="admin-view-title" class="font-bold text-lg mb-4 text-center"></h3>
                <div id="admin-view-entries-container" class="space-y-3 max-h-72 overflow-y-auto"></div>
                <button id="admin-view-close-btn" class="mt-6 w-full bg-gray-500 text-white p-3 rounded-lg font-bold hover:bg-gray-600 transition">關閉</button>
            </div>
        </div>

        <!-- Global Components -->
        <div id="loading-spinner" class="hidden absolute inset-0 bg-black bg-opacity-25 flex items-center justify-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-500"></div>
        </div>
        <div id="toast-notification" class="hidden fixed bottom-8 left-1/2 -translate-x-1/2 bg-gray-900 text-white py-2 px-5 rounded-lg shadow-xl">
            <p id="toast-message"></p>
        </div>
    </div>

<script>
// ===============================================================
// ===             請在此處填入您的 API Script URL             ===
// ===============================================================
const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzuK6eesYOdiW9UssX_ZsP0LSGrb8_BW7XwN0Jyu_LUzwtTz2FzZXF3BJHKcp6QG6pb/exec';
// ===============================================================


// --- Main Application Logic ---
document.addEventListener('DOMContentLoaded', () => {
    // DOM Elements
    const pages = {
        login: document.getElementById('login-page'),
        main: document.getElementById('main-page'),
        admin: document.getElementById('admin-page')
    };
    const loadingSpinner = document.getElementById('loading-spinner');
    const toast = {
        element: document.getElementById('toast-notification'),
        message: document.getElementById('toast-message'),
        show: function (msg) {
            this.message.textContent = msg;
            this.element.classList.remove('hidden');
            this.element.classList.add('toast-show');
            setTimeout(() => {
                this.element.classList.remove('toast-show');
                this.element.classList.add('hidden');
            }, 3000);
        }
    };

    // State Management
    const state = {
        currentUser: null,
        currentDate: new Date(),
        adminSelectedUser: null,
        adminCurrentDate: new Date(),
        studyData: {},
        allStudentIds: []
    };
    
    // Constants
    const SUBJECTS = ['中文', '英文', '數學', '公社', '物理', '化學', '生物', 'M2', '中史', '西史', '地理', '經濟', '旅款', '企會財', 'ICT'];
    const DSE_EXAM_DATES = {
        "2026-04-08": "視覺藝術",
        "2026-04-09": "中國語文 (一)及(二)",
        "2026-04-10": "英國語文 (一)及(二)",
        "2026-04-11": "英國語文 (三)",
        "2026-04-13": "數學 必修部分",
        "2026-04-14": "公民與社會發展",
        "2026-04-16": "化學 (一)及(二)",
        "2026-04-20": "生物 (一)及(二)",
        "2026-04-22": "物理 (一)及(二)",
        "2026-04-23": "地理 (一)及(二)",
        "2026-04-24": "資訊及通訊科技 (一)及(二)",
        "2026-04-25": "歷史 (一)及(二)",
        "2026-04-27": "企業、會計與財務概論 (一)及(二)",
        "2026-04-29": "中國歷史 (一)及(二)",
        "2026-04-30": "數學 延伸部分單元 (一)及(二)",
        "2026-05-02": "旅遊與款待 (一)及(二)",
        "2026-05-04": "經濟 (一)及(二)"
    };
    const QUOTES = [
        "成功不是偶然，是努力的必然結果。",
        "今天的汗水，是明天的微笑。",
        "相信自己，你能做的比想像中更多。",
        "每一次的努力，都是在為未來鋪路。",
        "堅持下去，夢想就在不遠處。",
        "不要害怕失敗，它是成功之母。",
        "專注當下，一步一腳印地前進。",
        "最大的敵人，是放棄的自己。",
        "知識改變命運，學習成就未來。",
        "為夢想而戰，你將無所不能。"
    ];


    // --- Utility Functions ---
    const showSpinner = () => loadingSpinner.classList.remove('hidden');
    const hideSpinner = () => loadingSpinner.classList.add('hidden');
    const formatDate = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };

    // --- API Communication ---
    async function callApi(action, payload) {
        if (!GAS_WEB_APP_URL || GAS_WEB_APP_URL === 'YOUR_GAS_WEB_APP_URL_HERE') {
            toast.show("錯誤：未設定後端 API 網址");
            console.error("GAS_WEB_APP_URL is not set.");
            return { success: false, message: "API URL not configured." };
        }
        showSpinner();
        try {
            const response = await fetch(GAS_WEB_APP_URL, {
                method: 'POST',
                mode: 'cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ action, payload }),
                redirect: 'follow'
            });
            
            if (!response.ok) {
                 throw new Error(`伺服器錯誤: ${response.statusText}`);
            }

            const result = await response.json();
            return result;

        } catch (error) {
            console.error('API 呼叫失敗:', error);
            toast.show(`與伺服器通訊時發生錯誤: ${error.message}`);
            return { success: false, message: error.toString() };
        } finally {
            hideSpinner();
        }
    }

    // --- Page Navigation ---
    function navigateTo(pageName) {
        Object.values(pages).forEach(page => page.classList.add('hidden'));
        if (pages[pageName]) {
            pages[pageName].classList.remove('hidden');
            pages[pageName].classList.add('flex');
        }
    }

    // --- Login Page Logic ---
    function setupLoginPage() {
        const dseTargetDate = new Date('2026-04-09T00:00:00');
        const countdownTimer = document.getElementById('countdown-timer');
        const dailyQuote = document.getElementById('daily-quote');
        
        function updateCountdown() {
            const now = new Date();
            const diff = dseTargetDate - now;
            const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
            countdownTimer.textContent = `${days} 日`;
        }
        
        dailyQuote.textContent = QUOTES[Math.floor(Math.random() * QUOTES.length)];
        updateCountdown();
        setInterval(updateCountdown, 1000 * 60); // Update every minute
    }

    async function handleLogin() {
        const id = document.getElementById('user-id').value.trim();
        const pw = document.getElementById('user-pw').value.trim();
        if (!id || !pw) {
            toast.show('ID和密碼不能為空');
            return;
        }

        const result = await callApi('checkLogin', { id, pw });

        if (result.success) {
            state.currentUser = { id, role: result.data.role };
            if (result.data.role === 'admin') {
                initializeAdminPage();
            } else {
                initializeMainPage();
            }
        } else {
            toast.show(result.message || '登入失敗');
        }
    }
    
    // --- Main Page & Calendar Logic ---
    function renderCalendar(date, containerId, studyData, isAdminView = false) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        const month = date.getMonth();
        const year = date.getFullYear();

        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        const monthYearEl = document.getElementById(isAdminView ? 'admin-current-month-year' : 'current-month-year');
        monthYearEl.textContent = `${year}年 ${month + 1}月`;

        for (let i = 0; i < firstDayOfMonth; i++) {
            container.innerHTML += '<div></div>';
        }

        for (let i = 1; i <= daysInMonth; i++) {
            const dayDate = new Date(year, month, i);
            const dateStr = formatDate(dayDate);
            const dayEl = document.createElement('div');
            dayEl.className = 'p-1 text-center cursor-pointer flex flex-col items-center justify-center rounded-lg aspect-square transition duration-200';
            
            const dayNumber = document.createElement('span');
            dayNumber.textContent = i;
            dayEl.appendChild(dayNumber);

            const today = new Date();
            if (i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                dayNumber.className = 'bg-indigo-600 text-white rounded-full h-6 w-6 flex items-center justify-center';
            } else {
                 dayNumber.className = 'h-6 w-6 flex items-center justify-center';
            }
            
            const dataForDay = studyData[dateStr];
            if (dataForDay) {
                const checkmark = document.createElement('span');
                checkmark.textContent = '✅';
                checkmark.className = 'text-xs mt-1';
                dayEl.appendChild(checkmark);
                if (isAdminView) {
                     dayEl.addEventListener('click', () => {
                        try {
                           const parsedData = JSON.parse(dataForDay);
                           adminViewModal.open(dateStr, parsedData);
                        } catch(e) {
                           adminViewModal.open(dateStr, []); // Or handle old format
                        }
                     });
                }
            }

            if(DSE_EXAM_DATES[dateStr]){
                const examLabel = document.createElement('div');
                examLabel.textContent = DSE_EXAM_DATES[dateStr];
                examLabel.className = 'text-xs text-red-500 dark:text-red-400 mt-1 truncate leading-tight';
                dayEl.appendChild(examLabel);
                dayEl.classList.add('bg-red-100', 'dark:bg-red-900/50');
            } else {
                 dayEl.classList.add('hover:bg-gray-100', 'dark:hover:bg-gray-700');
            }

            if (!isAdminView) {
                dayEl.addEventListener('click', () => editModal.open(dateStr));
            }
            
            container.appendChild(dayEl);
        }
    }
    
    // --- Data Fetching ---
    async function fetchDataForUser(userId) {
        const result = await callApi('getStudyData', { userId });
        if(result.success) {
            state.studyData = result.data || {};
            if(state.currentUser && state.currentUser.role === 'student') {
                renderCalendar(state.currentDate, 'calendar-body', state.studyData);
            } else if (state.currentUser && state.currentUser.role === 'admin') {
                 renderCalendar(state.adminCurrentDate, 'admin-calendar-body', state.studyData, true);
            }
        }
    }
    
    // --- Edit Modal Logic ---
    const editModal = {
        element: document.getElementById('edit-modal'),
        dateEl: document.getElementById('modal-date'),
        entriesContainer: document.getElementById('entries-container'),
        currentDate: null,
        
        open: function(dateStr) {
            this.currentDate = dateStr;
            this.dateEl.textContent = dateStr;
            this.renderEntries();
            this.element.classList.remove('hidden');
        },
        close: function() {
            this.element.classList.add('hidden');
        },
        renderEntries: function() {
            this.entriesContainer.innerHTML = '';
            const dataStr = state.studyData[this.currentDate];
            let entries = [];
            if(dataStr) {
                try {
                    entries = JSON.parse(dataStr);
                } catch(e) {
                    // Backwards compatibility for old plain text
                    entries = [{ subject: SUBJECTS[0], hours: '', content: dataStr }];
                }
            }

            if (entries.length === 0) {
                this.addEntryElement();
            } else {
                entries.forEach(entry => this.addEntryElement(entry));
            }
        },
        addEntryElement: function(entry = { subject: SUBJECTS[0], hours: '', content: '' }) {
            const entryDiv = document.createElement('div');
            entryDiv.className = 'p-2 border rounded-lg mb-2 flex items-center gap-2 bg-gray-50 dark:bg-gray-700/50';
            entryDiv.innerHTML = `
                <div class="flex-grow">
                    <select class="subject-select w-full bg-transparent p-1 rounded">
                        ${SUBJECTS.map(s => `<option value="${s}" ${s === entry.subject ? 'selected' : ''}>${s}</option>`).join('')}
                    </select>
                    <div class="flex gap-2 mt-1">
                        <input type="number" step="0.01" class="hours-input w-1/3 bg-transparent p-1 rounded" placeholder="時數" value="${entry.hours}">
                        <input type="text" class="content-input w-2/3 bg-transparent p-1 rounded" placeholder="溫習內容" value="${entry.content}">
                    </div>
                </div>
                <button class="remove-entry-btn text-red-500 p-1 rounded-full hover:bg-red-100 dark:hover:bg-red-900/50">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </button>
            `;
            entryDiv.querySelector('.remove-entry-btn').addEventListener('click', () => entryDiv.remove());
            this.entriesContainer.appendChild(entryDiv);
        },
        save: async function() {
            const entryElements = this.entriesContainer.querySelectorAll('.p-2.border');
            const entries = [];
            let hasError = false;
            entryElements.forEach(el => {
                const subject = el.querySelector('.subject-select').value;
                const hoursInput = el.querySelector('.hours-input');
                const content = el.querySelector('.content-input').value.trim();
                
                let hours = parseFloat(hoursInput.value);
                if (isNaN(hours) || hours < 0) {
                     toast.show("時數必須是正數");
                     hasError = true;
                     return;
                }
                hours = Math.round(hours * 100) / 100; // Round to 2 decimal places
                
                if (hours > 0 || content) { // Only save if there's some data
                     entries.push({ subject, hours: hours || 0, content });
                }
            });

            if(hasError) return;

            const result = await callApi('saveStudyData', {
                userId: state.currentUser.id,
                date: this.currentDate,
                content: entries
            });

            if (result.success) {
                await fetchDataForUser(state.currentUser.id);
                this.close();
                toast.show('儲存成功！');
            } else {
                toast.show(result.message || '儲存失敗');
            }
        }
    };
    
    // --- Stats Modal Logic ---
    const statsModal = {
        element: document.getElementById('stats-modal'),
        open: function(isForAdmin = false) {
            const date = isForAdmin ? state.adminCurrentDate : state.currentDate;
            const data = state.studyData;
            const userId = isForAdmin ? state.adminSelectedUser : state.currentUser.id;

            document.getElementById('stats-title').textContent = `${userId} 的溫習時數統計`;
            document.getElementById('stats-month').textContent = `${date.getFullYear()}年 ${date.getMonth() + 1}月`;
            
            let totalHours = 0;
            const subjectHours = {};
            SUBJECTS.forEach(s => subjectHours[s] = 0);
            
            const monthStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

            for (const dateStr in data) {
                if (dateStr.startsWith(monthStr)) {
                    try {
                        const entries = JSON.parse(data[dateStr]);
                        if(Array.isArray(entries)) {
                            entries.forEach(entry => {
                                const hours = parseFloat(entry.hours) || 0;
                                totalHours += hours;
                                if (subjectHours.hasOwnProperty(entry.subject)) {
                                    subjectHours[entry.subject] += hours;
                                }
                            });
                        }
                    } catch(e) { /* ignore old format */ }
                }
            }

            document.getElementById('total-hours').textContent = totalHours.toFixed(2);
            const container = document.getElementById('subject-stats-container');
            container.innerHTML = '';
            
            Object.entries(subjectHours)
                .filter(([_, hours]) => hours > 0)
                .sort((a, b) => b[1] - a[1])
                .forEach(([subject, hours]) => {
                    const el = document.createElement('div');
                    el.className = 'flex justify-between items-center text-sm';
                    el.innerHTML = `
                        <span>${subject}</span>
                        <span class="font-semibold">${hours.toFixed(2)} 小時</span>
                    `;
                    container.appendChild(el);
            });
            
            this.element.classList.remove('hidden');
        },
        close: function() {
            this.element.classList.add('hidden');
        }
    };

    // --- Admin View Modal ---
    const adminViewModal = {
        element: document.getElementById('admin-view-modal'),
        open: function(dateStr, entries) {
            document.getElementById('admin-view-title').textContent = `查看 ${dateStr} 的紀錄`;
            const container = document.getElementById('admin-view-entries-container');
            container.innerHTML = '';

            if(Array.isArray(entries) && entries.length > 0) {
                entries.forEach(entry => {
                    const el = document.createElement('div');
                    el.className = 'p-3 bg-gray-100 dark:bg-gray-700 rounded-lg';
                    el.innerHTML = `
                        <p class="font-bold text-indigo-500">${entry.subject} - <span class="text-gray-800 dark:text-gray-200">${entry.hours} 小時</span></p>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">${entry.content || '<i>沒有內容</i>'}</p>
                    `;
                    container.appendChild(el);
                });
            } else {
                 container.innerHTML = `<p class="text-center text-gray-500">當天沒有紀錄。</p>`;
            }
            this.element.classList.remove('hidden');
        },
        close: function() {
            this.element.classList.add('hidden');
        }
    };


    // --- Page Initializers ---
    function initializeMainPage() {
        document.getElementById('current-user-id').textContent = `你好, ${state.currentUser.id}`;
        navigateTo('main');
        renderCalendar(state.currentDate, 'calendar-body', state.studyData);
        fetchDataForUser(state.currentUser.id);
    }
    
    async function initializeAdminPage() {
        navigateTo('admin');
        const result = await callApi('getAllStudentIds', {});
        if (result.success && result.data.length > 0) {
            state.allStudentIds = result.data;
            const selector = document.getElementById('student-selector');
            selector.innerHTML = state.allStudentIds.map(id => `<option value="${id}">${id}</option>`).join('');
            state.adminSelectedUser = state.allStudentIds[0];
            fetchDataForUser(state.adminSelectedUser);
            renderCalendar(state.adminCurrentDate, 'admin-calendar-body', state.studyData, true);
        } else if (!result.success) {
            toast.show("無法獲取學生列表");
        }
    }

    // --- Event Listeners Setup ---
    function setupEventListeners() {
        document.getElementById('login-btn').addEventListener('click', handleLogin);
        document.getElementById('user-pw').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleLogin();
        });
        
        // Main page controls
        document.getElementById('logout-btn').addEventListener('click', () => location.reload());
        document.getElementById('prev-month-btn').addEventListener('click', () => {
            state.currentDate.setMonth(state.currentDate.getMonth() - 1);
            renderCalendar(state.currentDate, 'calendar-body', state.studyData);
        });
        document.getElementById('next-month-btn').addEventListener('click', () => {
            state.currentDate.setMonth(state.currentDate.getMonth() + 1);
            renderCalendar(state.currentDate, 'calendar-body', state.studyData);
        });

        // Admin page controls
        document.getElementById('admin-logout-btn').addEventListener('click', () => location.reload());
        document.getElementById('student-selector').addEventListener('change', (e) => {
            state.adminSelectedUser = e.target.value;
            fetchDataForUser(state.adminSelectedUser);
        });
         document.getElementById('admin-prev-month-btn').addEventListener('click', () => {
            state.adminCurrentDate.setMonth(state.adminCurrentDate.getMonth() - 1);
            renderCalendar(state.adminCurrentDate, 'admin-calendar-body', state.studyData, true);
        });
        document.getElementById('admin-next-month-btn').addEventListener('click', () => {
            state.adminCurrentDate.setMonth(state.adminCurrentDate.getMonth() + 1);
            renderCalendar(state.adminCurrentDate, 'admin-calendar-body', state.studyData, true);
        });


        // Modals controls
        document.getElementById('modal-save-btn').addEventListener('click', () => editModal.save());
        document.getElementById('modal-close-btn').addEventListener('click', () => editModal.close());
        document.getElementById('add-entry-btn').addEventListener('click', () => editModal.addEntryElement());

        document.getElementById('stats-btn').addEventListener('click', () => statsModal.open());
        document.getElementById('stats-close-btn').addEventListener('click', () => statsModal.close());
        document.getElementById('admin-stats-btn').addEventListener('click', () => statsModal.open(true));
        
        document.getElementById('admin-view-close-btn').addEventListener('click', () => adminViewModal.close());
    }

    // --- App Initialization ---
    function init() {
        setupLoginPage();
        setupEventListeners();
        navigateTo('login');
    }

    init();
});
</script>
</body>
</html>

